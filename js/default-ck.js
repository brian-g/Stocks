// "use strict";
function error(e){var t=$("#error").text(e);t.slideDown(750,function(){setTimeout(function(){t.slideUp("fast")},5e3)})}function construct_statement(){var e="(";jQuery.each(stocks,function(t,n){e+='"'+n+'"'+(t<stocks.length-1?",":"")});return e+=")"}function update_stocks(){var e=magicStatement+construct_statement(),t=new Date;if(t.getUTCHours()<marketUtcOpen||t.getUTCHours()>marketUtcClose||t.getDay()===0||t.getDay()===6)return;$.queryYQL(e,magicEnv,function(e){if(e.error){console.log("YQL Error:"+e.error.description);error(error_str)}else if(e.query.count>0){var t=new Date;jQuery.each(e.query.results.quote,function(e,t){var n=$(".stock[data-id="+t.Symbol+"]"),r,i;n.find(".stock-Bid").text(t.LastTradePriceOnly);n.find(".stock-Change").attr("data-change-indicator",t.Change<0?"down":"up");n.find(".stock-ChangePercent").text(t.PercentChange);n.find(".stock-ChangeValue").text(t.Change);r=n.find(".stock-ChartContainer");i=$('<div class="stock-ChartContainer" style="opacity:0;background-image:url(http://chart.finance.yahoo.com/z?s='+t.Symbol+"&t=1d&z=s&"+(new Date).getTime()+')"></div>');r.parent().append(i);setTimeout(function(){i.css("opacity","1");r.remove()},1e3)});$("#status").text("Last updated: "+t.toLocaleTimeString())}else{error(error_str);console.log("YQL Error: whoops. that strange place")}})}function showStocks(){$(".stock").css("opacity","1");$("#activity").css("opacity","0")}function fill_stocks(){var e=$("#stock-list").empty(),t=magicStatement+construct_statement();$.queryYQL(t,magicEnv,function(t){if(t.error){error(error_str);console.log(t.error.description);showStocks()}else if(t.query.count>0){var n=new Date;$("#stock-template").tmpl(t.query.results.quote).appendTo(e);e.append('<a href="#" data-action="add" class="stock"><div class="stock-add"><input autocapitalize="off" autocorrect="off" style="display:none" placeholder="(e.g. AAPL)" type="text" maxlength="10"><span class="icon-plus">Add stock</span></div></a>');$('[data-action="add"]').on("click",function(e){e.preventDefault();show_stock_add($(this))});var r=0;$(".stock").each(function(){$(this).css("transition-delay",r+"ms");r+=delay});setTimeout(showStocks,400);$("#status").text("Last updated: "+n.toLocaleTimeString())}else{var i;error(error_str);console.log("YQL Error: something happened. not sure what");for(i in t.query)console.log(i+"="+t[i]);showStocks()}})}function validate_stock(e){alert(e)}function show_stock_add(e){var t=e.find("input").fadeIn();e.find(".icon-plus").fadeOut();t.focus()}function revert_stock_add(e){e.find("input").fadeOut();e.find(".icon-plus").fadeIn()}function remove_stock(){}function reorder_stock(){}function init_storage(){typeof Storage!="undefined"?localStorage.stocks!==undefined?stocks=JSON.parse(localStorage.stocks):localStorage.stocks=JSON.stringify(stocks):console.log("HTML Error: no local storage")}var error_str="Error retrieving stock information",magicEnv="store://datatables.org/alltableswithkeys",magicStatement="select Symbol, Name, Bid, LastTradePriceOnly, PreviousClose, Change, PercentChange from yahoo.finance.quotes where symbol in ",validateStatement="select symbol from yahoo.finance.stocks where symbol=",marketUtcOpen=13,marketUtcClose=21,delay=100,stocks=["YHOO","AAPL","GOOG","MSFT","NOK","DIS","DJIA","HP","F","BP","BBY"],intervalID;$(document).ready(function(){$("#activity").css("top",$(window).height()/2-16);$("#activity").css("left",$(window).width()/2-16);$("#activity").css("opacity","1.0");init_storage();fill_stocks();intervalID=setInterval(update_stocks,3e5);$("body").on("change","input",function(){revert_stock_add($(this).parent());validate_stock($(this).val())})});